<div class='user_card'>
	<div>
		<a  class='user_avatar'  href="/user/<%= user.name %>">
			<img src="<%= user.avatar_url %>" title="<%= user.name %>" />
		</a>
		<span class='user_name'><a class='dark' href="/user/<%= user.name %>"><%= user.name %></a></span>

		<% if (typeof(current_user) !== 'undefined' && current_user._id != user._id) { %>
		    <div class="board clearfix">
			<% if (typeof(relation) === 'undefined' || !relation) { %>
				<button class='btn btn-success action_btn' action='follow'>加入关注</button>
                <button class='btn btn-success action_btn' action='user_block'>屏蔽此人</button>
			<% } else { %>
			    <% if (relation.follow_id) { %>
                    <button class='btn action_btn' action='un_follow'>取消关注</button>
                <% } else { %>
                    <button class='btn action_btn' action='user_unblock'>取消屏蔽</button>
                <% } %>
			<% } %>
			</div>
		<% } %>

		<div class='board clearfix'>
			<div class='floor'>
				<a href='/user/<%= user.name %>/collections'><span class='big'><%= user.collect_topic_count %></span> 话题收藏</a>
			</div>
			<div class='floor'>
				<a href='/user/<%= user.name %>/following'><span class='big'><%= user.following_count %></span> 关注</a>
				<div class='space'></div>
				<a href='/user/<%= user.name %>/follower'><span class='big'><%= user.follower_count %></span> 粉丝</a>
				<div class='space'></div>
                <% if (typeof(current_user) !== 'undefined' && current_user._id == user._id) { %>
                    <a href='/user/<%= user.name %>/blocking'><span class='big'><%= user.blocking_count %></span> 屏蔽</a>
                    <div class='space'></div>
                <% } %>
				<span class='big'><%= user.score %></span> 积分
			</div>
		</div>
	</div>
</div>

<% if (typeof(current_user) !== 'undefined') { %>
<script>
	$(document).ready(function () {
		$('.action_btn').click(function () {
			var $me = $(this);
			var action = $me.attr('action');
			var params = {
				target_id: '<%= user._id %>',
				_csrf: '<%- csrf %>'
			};
			$.post('/user/' + action, params, function (data) {
				if (data.status === 'success') {
				    var follow_btn = $('.action_btn[action="follow"]');
				    var block_btn = $('.action_btn[action="user_block"]');
					if (action === 'follow') {
					    block_btn.hide();
                        follow_btn.html('取消关注');
                        follow_btn.attr('action', 'un_follow');
                    } else if (action === 'user_block') {
                        follow_btn.hide();
                        block_btn.html('取消屏蔽');
                        block_btn.attr('action', 'user_unblock');
					} else {
					    location.reload(true);
					}
					$('.action_btn').toggleClass('btn-success')
				}
			}, 'json');
		});
	});
</script>
<% } %>
